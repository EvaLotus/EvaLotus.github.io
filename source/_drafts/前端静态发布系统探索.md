---
title: 前端静态发布系统探索
date: 2019-01-04 18:16:56
tags: frontend team
---
现代的静态发布系统探索
<!-- more -->

#### 建议的发布方式

1.前后端分离，npm run build，将静态资源上cdn

2.将入口文件index放在server端返回。

#### 代码层面

在webpack中，不仅仅分离vendor.js，对于稳定的功能，也可以在webpack中动静分离，分成经常改的文件和不经常修改的。

#### 覆盖式发布还是非覆盖式发布？

如果每次发布都在原来的文件基础上修改，每次都覆盖式发布文件，只是在访问时 [http://evacode.com/static/a.js?v=1.0](http://evacode.com/static/a.js?v=1.0) ,修改v后面的版本号。这样不仅回滚时不好操作，而且版本非常容易混淆。

mi使用的发布系统是与git关联的，后来和sre沟通，发现真的是每个版本都留着，现在7年多了，其实占用的磁盘资源并没有想象的那么多。但是静态资源上cdn，cdn上还是需要定期清理。

更新资源发布路径实现非覆盖式发布。

#### 静态资源的入口文件index放在server项目中还是不放？

思考场景

1.后端修改了接口，增加了参数，如果后端先上线了，前端后上线的话，中间时间点访问网站的用户因为缺少参数就不可用了。

2.后端新增了一个接口，前端先上线，后端还没部署，中间时间点访问网站的用户就会发现404了。

一个功能需要前后端协同开发，功能上有依赖，如果不能一起发布的话，总是会出现用户暂时访问有问题的情况。

但是如果放在一起的话，前端修改个css，后端需要几百台机器全部上个线，总不好意思每次都让后端同学那么辛苦的上线。

前端的静态资源入口文件，不管是index.htm还是index.jsp等等，在开发过程中，都可以直接scp到服务器上，并不需要后台编译。

所以结论是：

静态资源的入口文件应该放在server端项目。但是在部署系统上，应该同时实现两种情况的部署系统：

1.前后端同时发布，主要用于一个需要前后端协同开发的功能发布。

2.前端简单的发布index.html，主要用在与后端无关的前端发布上，如文案，css等。此时只需要把入口文件scp到项目中即可。

每次部署先发布静态资源再发布server端项目

#### 打包上线去本地化

发布机上有docker image，在发布机上进行`npm run build`，将文件部署到cdn上。

TODO，文件丢到cdn，我们需要做什么。

#### 回滚操作

前后端有依赖的功能，全量回滚。

前后端无依赖的功能，直接回滚index到上个版本。

全程不用回滚静态资源发布，因为是非覆盖式发布，只需要修改index中的版本即可。

#### 缓存设置

静态资源因为有版本号，可以全部都设超长缓存时间。

index设置no-cache。

##### 公司的xbox系统

[https://www.ibm.com/developerworks/cn/opensource/os-cn-puppet/index.html](https://www.ibm.com/developerworks/cn/opensource/os-cn-puppet/index.html)

[https://puppet.com/](https://puppet.com/)

封装了puppet等开源项目，在Git项目中加上deploy文件之后，xbox就可以从git上拉代码，选择git版本进行编译

#### 前端静态文件发布的过程：

稳定性和编译能力

git拉代码，文件copy，机器打通
